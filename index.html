<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ASCII Raymarcher • Optimized</title>
<link rel="stylesheet" href="css/style.css">
</head>
<style>
  /* Modular panel toggle: hide panel when not .open */
  #panel { display: block; transition: max-height 0.2s; }
  #panel:not(.open) { display: none; }
</style>
</head>

<body>
<!-- Modular templates -->
<template id="tpl-topbar">
  <div id="topbar">
    <span id="title">ASCII Raymarcher</span>
    <span class="pill tiny">Optimized • TAA • Adaptive • SDF</span>
    <span class="spacer"></span>
    <button id="panelBtn" title="Toggle Controls (mobile)">Controls<span id="mobileTip"> ☰</span></button>
    <button id="fullscreenBtn" title="Fullscreen">Fullscreen</button>
    <span id="fps">FPS: --</span>
  </div>
</template>

<template id="tpl-viewer">
  <div id="viewer">
    <canvas id="canvas"></canvas>
    <div id="hud" class="tiny">Drag to orbit • Wheel to zoom • Keys: WASD, QE, R reset</div>
  </div>
</template>

<template id="tpl-panel">
  <div id="panel">
    <!-- ...existing code... (all the <details> sections for panel) ... -->
    <details open>
      <summary>Scene</summary>
      <div class="group">
        <label>Shape
          <select id="shape">
              <option>Sphere</option>
              <option>Box</option>
              <option selected>Torus</option>
              <option>Octahedron</option>
              <option>Capsule</option>
              <option>Cylinder</option>
              <option>Cone</option>
              <option>Pyramid</option>
              <option>Ellipsoid</option>
              <option>RoundedBox</option>
              <option>TriPrism</option>
              <option>HexPrism</option>
              <option>Plane</option>
              <option>Cross</option>
              <option>Tetrahedron</option>
              <option>Star</option>
              <option>Heart</option>
              <option>Egg</option>
          </select>
        </label>
        <label>Size <input id="size" type="range" min="0.2" max="2.5" step="0.01" value="1.1"></label>
        <div class="row">
          <span class="tiny" style="width:68px">Rotation</span>
          <input id="rotX" type="range" min="-180" max="180" step="1" value="20" class="grow">
        </div>
        <div class="row">
          <span class="tiny" style="width:68px"></span>
          <input id="rotY" type="range" min="-180" max="180" step="1" value="35" class="grow">
        </div>
        <div class="row">
          <span class="tiny" style="width:68px"></span>
          <input id="rotZ" type="range" min="-180" max="180" step="1" value="0" class="grow">
        </div>
        <div class="row">
          <label class="inline"><input id="autoSpin" type="checkbox" checked> Auto spin</label>
          <label>Speed <input id="spinSpeed" type="range" min="-3" max="3" step="0.01" value="0.6"></label>
        </div>
      </div>
    </details>
    <details open>
      <summary>Lighting</summary>
      <div class="group">
        <label>Ambient <input id="ambient" type="range" min="0" max="1" step="0.01" value="0.25"></label>
        <label>Diffuse <input id="diffuse" type="range" min="0" max="2" step="0.01" value="1.05"></label>
        <label>Specular <input id="specular" type="range" min="0" max="2" step="0.01" value="0.5"></label>
        <label>Shininess <input id="shininess" type="range" min="2" max="128" step="1" value="32"></label>
        <div class="row">
          <label class="inline"><input id="shadows" type="checkbox" checked> Shadows</label>
          <label>Softness <input id="shadowK" type="range" min="1" max="24" step="0.1" value="12"></label>
        </div>
        <div class="row">
          <label class="inline"><input id="ao" type="checkbox" checked> AO</label>
          <label>AO Strength <input id="aoStrength" type="range" min="0" max="2" step="0.01" value="0.9"></label>
        </div>
      </div>
    </details>
    <details open>
      <summary>Surface Noise / Animation</summary>
      <div class="group">
        <label class="inline"><input id="noiseEnabled" type="checkbox"> Enable noise</label>
        <label>Amount <input id="noiseAmt" type="range" min="0" max="0.8" step="0.001" value="0.16"></label>
        <label>Scale <input id="noiseScale" type="range" min="0.2" max="6" step="0.01" value="2.0"></label>
        <label>Speed <input id="noiseSpeed" type="range" min="0" max="4" step="0.01" value="0.9"></label>
        <label>Octaves <input id="noiseOct" type="range" min="1" max="6" step="1" value="3"></label>
      </div>
    </details>
    <details open>
      <summary>ASCII & Color</summary>
      <div class="group">
        <label>ASCII preset
          <select id="asciiPreset">
            <option value="dense">Dense</option>
            <option value="classic">Classic</option>
            <option value="blocks">Blocks</option>
            <option value="dots">Dots</option>
            <option value="binary">Binary</option>
          </select>
        </label>
        <label>Characters
          <input id="asciiChars" type="text" value=" .,'`^:;Il!i~+_-?][}{1)(|\/tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$">
        </label>
        <div class="row">
          <label class="inline"><input id="invert" type="checkbox"> Invert</label>
        </div>
        <div class="row">
          <label class="inline"><input id="colorEnabled" type="checkbox" checked> Color</label>
          <label>Gamma <input id="gamma" type="range" min="0.6" max="2.4" step="0.01" value="1.0"></label>
        </div>
        <label>Color mode
          <select id="colorMode">
            <option value="luma">Luma</option>
            <option value="depth">Depth</option>
            <option value="normal">Normal</option>
            <option value="specular">Specular</option>
            <option value="momentum">Momentum</option>
          </select>
        </label>
        <label>Palette
          <select id="palette">
            <option value="grayscale">Grayscale</option>
            <option value="fire">Fire</option>
            <option value="ice">Ice</option>
            <option value="viridis" selected>Viridis</option>
            <option value="rainbow">Rainbow</option>
          </select>
        </label>
      </div>
    </details>
    <details open>
      <summary>Render & Performance</summary>
      <div class="group">
        <label>Font size <input id="fontSize" type="range" min="8" max="28" step="1" value="14"></label>
        <label>Resolution <input id="resScale" type="range" min="0.5" max="2" step="0.01" value="1.0"></label>
        <label>Max steps <input id="maxSteps" type="range" min="16" max="180" step="1" value="72"></label>
        <label>Max distance <input id="maxDist" type="range" min="8" max="64" step="0.5" value="24"></label>
        <div class="row">
          <label class="inline"><input id="taa" type="checkbox" checked> Temporal AA</label>
          <label>Blend <input id="taaAmt" type="range" min="0" max="0.95" step="0.01" value="0.6"></label>
        </div>
        <div class="row">
          <label class="inline"><input id="adaptive" type="checkbox" checked> Adaptive res</label>
          <label>Target FPS <input id="targetFps" type="range" min="24" max="90" step="1" value="50"></label>
        </div>
        <div class="row">
          <button id="resetCam">Reset view</button>
          <button id="resetAll" title="Reset all controls">Reset all</button>
        </div>
        <div class="hint tiny">Pro tip: Adaptive res keeps FPS stable; increase Max steps for crisper shadows/edges.</div>
      </div>
    </details>
  </div>
</template>

<div id="app"></div>

<script>
// Modular injection of templates
const app = document.getElementById('app');
const topbar = document.getElementById('tpl-topbar').content.cloneNode(true);
const main = document.createElement('div');
main.id = 'main';
const viewer = document.getElementById('tpl-viewer').content.cloneNode(true);
const panel = document.getElementById('tpl-panel').content.cloneNode(true);
main.appendChild(viewer);
main.appendChild(panel);
app.appendChild(topbar);
app.appendChild(main);
</script>
<script src="js/math_utils.js"></script>
<script src="js/noise_value_noise_fbm.js"></script>
<script src="js/sdfs.js"></script>
<script src="js/scene_map_optimized.js"></script>
<script src="js/utils.js"></script>
<script src="js/ascii_dither.js"></script>
<script src="js/app_state.js"></script>
<script src="js/ui_wiring.js"></script>
<script src="js/resize_metrics_grid_cache.js"></script>
<script src="js/input.js"></script>
<!-- merged into utils.js -->
<script src="js/ray_helpers_culling.js"></script>
<script src="js/render_loop_taa_adaptive_res.js"></script>
<script src="js/boot.js"></script>
</body>
</html>